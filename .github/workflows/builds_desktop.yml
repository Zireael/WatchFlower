name: Desktop CI builds
on:
  push:
  pull_request:

jobs:
  build_linux:
    name: "Linux CI build"
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup variables
      run: |
        echo "APP_VERSION=1.0.0" >> $GITHUB_ENV

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.7.3'
        target: 'desktop'
        modules: 'qtconnectivity qtpositioning qtcharts'

    - name: Setup env
      run: |
        sudo apt-get update -y
        sudo apt-get install libgl1-mesa-dev -y

    - name: Build application
      run: |
        qmake --version
        mkdir build
        cd build/
        qmake ../WatchFlower.pro CONFIG+=release PREFIX=/usr
        make -j$(nproc)

  build_windows:
    name: "Windows CI build (${{ matrix.qt_arch }}, Qt ${{ matrix.qt_version }}, ${{ matrix.qt_tools }})"
    runs-on: windows-2022
    strategy:
      matrix:
        qt_version: [6.7.3]
        qt_arch: [win64_msvc2019_64]
        qt_tools: [tools_qtcreator,tools_qtcreator_gui]
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup variables
      run: |
        echo "APP_VERSION=1.0.0" >> $GITHUB_ENV

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ matrix.qt_version }}
        target: 'desktop'
        arch: ${{ matrix.qt_arch }}
        modules: 'qtconnectivity qtpositioning qtcharts'

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Setup cmake
      uses: lukka/get-cmake@latest

    - name: Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1

    - name: Build application
      run: |
        qmake --version
        mkdir build
        cd build/
        qmake ../WatchFlower.pro CONFIG+=release
        nmake

    - name: Deploy application
      run: |
        cd build/
        windeployqt --qmldir ../qml/ WatchFlower.exe

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: WatchFlower-${{ matrix.qt_arch }}-Qt${{ matrix.qt_version }}
        path: build/

  build_macOS:
    name: "macOS CI build"
    runs-on: macos-13
    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup variables
      run: |
        echo "APP_VERSION=1.0.0" >> $GITHUB_ENV

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.7.3'
        target: 'desktop'
        modules: 'qtconnectivity qtpositioning qtcharts'

    - name: Build application
      run: |
        qmake --version
        mkdir build
        cd build/
        qmake ../WatchFlower.pro CONFIG+=release
        make -j$(sysctl -n hw.logicalcpu)

    - name: Deploy application
      run: |
        cd build/
        macdeployqt WatchFlower.app -qmldir=../qml/ -appstore-compliant
