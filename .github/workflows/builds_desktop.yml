name: "Desktop CI builds"
on:
  push:
  pull_request:

jobs:

################################################################################

  build-linux:
    name: "Linux CI build"
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          target: 'desktop'
          modules: 'qtconnectivity qtcharts qtpositioning'

      - name: Build application
        run: |
          cmake -B build/ -DCMAKE_BUILD_TYPE=Release
          cmake --build build/ --config Release --parallel $(nproc)

################################################################################

  build-macOS:
    name: "macOS CI build"
    runs-on: macos-14
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          target: 'desktop'
          modules: 'qtconnectivity qtcharts qtpositioning'

      - name: Build application
        run: |
          cmake -B build/ -DCMAKE_BUILD_TYPE=Release
          cmake --build build/ --config Release --parallel $(sysctl -n hw.logicalcpu)

################################################################################

  build-windows:
    name: "Windows CI build"
    runs-on: windows-2022
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          modules: 'qtconnectivity qtcharts qtpositioning'

      - name: Build application
        run: |
          cmake -B build/ -DCMAKE_BUILD_TYPE=Release -G "Visual Studio 17 2022" -A x64
          cmake --build build/ --config Release --parallel

      - name: Deploy application
        run: |
          ./deploy_windows.sh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: WatchFlower-Windows-x64
          path: bin/
