name: "Desktop CI builds"
on:
  push:
  pull_request:

jobs:

################################################################################

  build_linux:
    name: "Linux CI build"
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          host: 'linux'
          target: 'desktop'
          modules: 'qtconnectivity qtcharts qtpositioning qt5compat qtshadertools'

      - name: Build application
        run: |
          qmake --version
          qmake PREFIX=/usr WatchFlower.pro CONFIG+=release
          make -j$(nproc)

      - name: Deploy application
        run: ./deploy_linux.sh

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: WatchFlower-linux-x86_64.AppImage
          path: bin/WatchFlower-linux-x86_64.AppImage

################################################################################

  build_mac:
    name: "macOS CI build"
    runs-on: macos-12
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          host: 'mac'
          target: 'desktop'
          modules: 'qtconnectivity qtcharts qtpositioning qt5compat qtshadertools'

      - name: Build application
        run: |
          qmake --version
          qmake WatchFlower.pro CONFIG+=release
          make -j$(sysctl -n hw.logicalcpu)

      - name: Deploy application
        run: ./deploy_macos.sh

      - name: Upload app bundle
        uses: actions/upload-artifact@v4
        with:
          name: WatchFlower-macOS-x86_64.zip
          path: bin/WatchFlower-macOS-x86_64.zip

################################################################################

  build_windows:
    name: "Windows CI build"
    runs-on: windows-2022
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          modules: 'qtconnectivity qtcharts qtpositioning qt5compat qtshadertools'

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Build application
        run: |
          qmake.exe --version
          qmake.exe WatchFlower.pro CONFIG+=release
          nmake.exe

      - name: Deploy application
        run: ./deploy_windows.sh

      - name: Upload Windows executable
        uses: actions/upload-artifact@v4
        with:
          name: WatchFlower-win64
          path: bin/WatchFlower-win64.zip
